# Minecraft Marketplace Deployment Commands
# Requires: just, docker, docker-compose

# Default recipe - show available commands
default:
    @just --list

# Variables
image_name := "minecraft-marketplace"
image_tag := "latest"
container_name := "minecraft-marketplace-app"
data_volume := "./data"
backup_dir := "./tmp/backups"
port := "7410"

# === Development Commands ===

# Install dependencies
install:
    npm install

# CURRENT DEPLOYMENT: Start development servers (assumes infrastructure is running)
dev:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üî• Starting development servers with hot reload..."
    echo ""
    echo "   ‚úÖ OUTCOME: Development servers will run with hot reload"
    echo "   üìç ACCESS: http://localhost:7410 (main interface)"
    echo "   üìä MONITORING: Logs will show in terminal"
    echo ""
    echo "   Development servers:"
    echo "   ‚Ä¢ Frontend: Astro + Svelte (internal port 7411)"
    echo "   ‚Ä¢ Backend:  Hono API (internal port 7412)" 
    echo ""
    echo "üí° Press Ctrl+C to stop all servers"
    echo ""
    
    # Start development servers with hot reload (foreground)
    npm run dev

# Start development environment with Nix orchestration
nix-up:
    process-compose up

# Run tests
test:
    npm test

# Run tests with UI
test-ui:
    npm run test:ui

# Run tests with coverage
test-coverage:
    npm run test:coverage

# Validate collaboration readiness - "Make it work for others before asking others to work on it"
validate-collaboration:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "ü§ù Validating Collaboration Readiness..."
    echo ""
    echo "Testing all 10 collaboration requirements + Definition of Done:"
    echo "  1. Fresh machine setup without custom configuration"
    echo "  2. Working demo others can access" 
    echo "  3. Documentation enables contribution"
    echo "  4. Deployable by someone who didn't build it"
    echo "  5. Tested handoff process"
    echo "  6. Clear deliverables and deadlines"
    echo "  7. Working code without debugging environment issues"
    echo "  8. Equal distribution of boring work"
    echo "  9. Self-contained projects needing no constant support"
    echo " 10. Processes serve team goals, not individual preferences"
    echo ""
    
    start_time=$(date +%s)
    
    # Run the comprehensive collaboration validation
    if npx vitest run --config vitest.collaboration.config.ts --reporter=verbose; then
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        
        echo ""
        echo "‚úÖ COLLABORATION VALIDATION PASSED"
        echo "‚è±Ô∏è  Completed in ${duration}s"
        echo ""
        echo "üéØ Project Status: READY FOR COLLABORATION"
        echo "   ‚Ä¢ All 10 requirements validated"
        echo "   ‚Ä¢ Definition of Done criteria met"
        echo "   ‚Ä¢ 30-minute stakeholder demo ready"
        echo ""
        echo "üöÄ Next Steps:"
        echo "   ‚Ä¢ Share repository with collaborators"
        echo "   ‚Ä¢ Run 'just fresh-install' to test end-to-end"
        echo "   ‚Ä¢ Demo to stakeholders with 'just demo'"
        echo ""
    else
        echo ""
        echo "‚ùå COLLABORATION VALIDATION FAILED"
        echo ""
        echo "üîß Project Status: NOT READY FOR COLLABORATION"
        echo "   ‚Ä¢ Fix failing requirements above"
        echo "   ‚Ä¢ Re-run 'just validate-collaboration'"
        echo "   ‚Ä¢ Do not share with collaborators until passing"
        echo ""
        exit 1
    fi

# === Database Commands ===

# Check database migration status
db-status:
    npm run db:status

# Run database migrations
db-migrate:
    npm run db:migrate

# Reset database (DESTRUCTIVE!)
db-reset:
    npm run db:reset -- --force

# Create database backup
db-backup:
    #!/usr/bin/env bash
    set -euo pipefail
    
    # Create backup directory
    mkdir -p {{ backup_dir }}
    
    # Create timestamped backup
    timestamp=$(date +%Y%m%d_%H%M%S)
    backup_file="{{ backup_dir }}/minecraft-marketplace-${timestamp}.db"
    
    if [ -f "{{ data_volume }}/minecraft-marketplace.db" ]; then
        cp "{{ data_volume }}/minecraft-marketplace.db" "$backup_file"
        echo "‚úÖ Database backed up to: $backup_file"
    else
        echo "‚ùå Database file not found at {{ data_volume }}/minecraft-marketplace.db"
        exit 1
    fi

# Restore database from backup
db-restore backup_file:
    #!/usr/bin/env bash
    set -euo pipefail
    
    if [ ! -f "{{ backup_file }}" ]; then
        echo "‚ùå Backup file not found: {{ backup_file }}"
        exit 1
    fi
    
    # Create data directory
    mkdir -p {{ data_volume }}
    
    # Stop container if running
    docker stop {{ container_name }} 2>/dev/null || true
    
    # Restore backup
    cp "{{ backup_file }}" "{{ data_volume }}/minecraft-marketplace.db"
    echo "‚úÖ Database restored from: {{ backup_file }}"

# === Docker Build Commands ===

# Build production Docker image
build:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üî® Building production Docker image..."
    docker build \
        --tag {{ image_name }}:{{ image_tag }} \
        --tag {{ image_name }}:$(date +%Y%m%d-%H%M%S) \
        .
    
    echo "‚úÖ Docker image built successfully!"
    echo "   Image: {{ image_name }}:{{ image_tag }}"

# Build with no cache (clean build)
build-clean:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üî® Building production Docker image (clean build)..."
    docker build \
        --no-cache \
        --tag {{ image_name }}:{{ image_tag }} \
        --tag {{ image_name }}:$(date +%Y%m%d-%H%M%S) \
        .
    
    echo "‚úÖ Docker image built successfully!"

# === Docker Run Commands ===

# PRODUCTION DEPLOYMENT: Start all services in production mode
infra:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üê≥ Starting production infrastructure services..."
    echo ""
    echo "   ‚úÖ OUTCOME: Full production stack will be running"
    echo "   üìç ACCESS: http://localhost:7410 (nginx reverse proxy)"
    echo "   üéØ PURPOSE: Complete deployment, not just infrastructure"
    echo ""
    
    docker compose up -d
    
    # Wait for services to be ready
    echo "‚è≥ Waiting for services to be ready..."
    timeout=60
    while ! curl -f -s http://localhost:7410 > /dev/null 2>&1; do
        sleep 2
        timeout=$((timeout - 2))
        if [ $timeout -le 0 ]; then
            echo "‚ùå Services failed to start within 60 seconds"
            echo "üìã Check status: docker compose ps"
            exit 1
        fi
    done
    
    echo ""
    echo "üéâ PRODUCTION DEPLOYMENT COMPLETE!"
    echo "   üåê Main interface: http://localhost:7410"
    echo "   üìä API documentation: http://localhost:7410/docs"
    echo "   üê≥ Database API: http://localhost:7410/api/data"
    echo ""
    echo "üìã Management commands:"
    echo "   ‚Ä¢ just status    - Check service health"
    echo "   ‚Ä¢ just logs      - View application logs"
    echo "   ‚Ä¢ just down      - Stop all services"

# DEVELOPMENT MODE: Start development servers with file watching
up:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üöÄ Starting development environment with file watching..."
    echo ""
    echo "   ‚úÖ OUTCOME: Development servers with hot reload"
    echo "   üìç ACCESS: http://localhost:7410"
    echo "   üîÑ FEATURES: File changes auto-reload"
    echo "   ‚ö†Ô∏è  WARNING: For development only - use 'just infra' for production"
    echo ""
    
    # Check if we should use development compose file
    if [ -f "compose.dev.yml" ]; then
        echo "üê≥ Starting development infrastructure..."
        docker compose -f compose.dev.yml up -d postgres valkey postgrest nginx
        
        # Wait for database to be ready
        echo "‚è≥ Waiting for database to be ready..."
        timeout=30
        while ! docker compose -f compose.dev.yml exec postgres pg_isready -U dev_user -d minecraft_marketplace_dev >/dev/null 2>&1; do
            sleep 1
            timeout=$((timeout - 1))
            if [ $timeout -eq 0 ]; then
                echo "‚ùå Database failed to start within 30 seconds"
                exit 1
            fi
        done
        
        echo "üî• Starting development servers..."
        npm run dev
    else
        echo "‚ö†Ô∏è  No compose.dev.yml found - using production deployment"
        just infra
    fi

# Run container in development mode (with live reloading)
deploy-dev:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üöÄ Deploying in development mode..."
    
    # Stop existing container
    docker stop {{ container_name }}-dev 2>/dev/null || true
    docker rm {{ container_name }}-dev 2>/dev/null || true
    
    # Run development container with source mounting
    docker run \
        --name {{ container_name }}-dev \
        --detach \
        --restart unless-stopped \
        --publish {{ port }}:4321 \
        --volume "$(pwd):/app" \
        --volume "$(pwd)/{{ data_volume }}:/app/data" \
        --workdir /app \
        --env NODE_ENV=development \
        node:20-alpine \
        sh -c "npm install && npm run dev"
    
    echo "‚úÖ Development deployment started!"
    echo "   URL: http://localhost:{{ port }}"

# === Container Management ===

# CHECK STATUS: Show current deployment status and access information
status:
    #!/usr/bin/env bash
    echo "üìä Minecraft Marketplace Status"
    echo "================================"
    echo ""
    
    # Check if services are running
    if docker compose ps --quiet | grep -q .; then
        echo "‚úÖ DEPLOYMENT STATUS: Services are running"
        echo ""
        echo "üåê ACCESS POINTS:"
        echo "   ‚Ä¢ Main interface: http://localhost:7410"
        echo "   ‚Ä¢ API docs: http://localhost:7410/docs"
        echo "   ‚Ä¢ Database API: http://localhost:7410/api/data"
        echo ""
        echo "üìã SERVICE HEALTH:"
        docker compose ps
        
        echo ""
        echo "üè• CONNECTIVITY TEST:"
        if curl -f -s http://localhost:7410 > /dev/null 2>&1; then
            echo "   ‚úÖ Main interface: RESPONDING"
        else
            echo "   ‚ùå Main interface: NOT RESPONDING"
        fi
    else
        echo "‚ùå DEPLOYMENT STATUS: No services running"
        echo ""
        echo "üöÄ TO START: just infra (production) or just up (development)"
    fi

# View recent logs (raw docker)
logs-recent:
    docker logs --tail 50 {{ container_name }}

# Stop the application
stop:
    #!/usr/bin/env bash
    echo "üõë Stopping Minecraft Marketplace..."
    docker stop {{ container_name }} || true
    echo "‚úÖ Application stopped"

# Start existing container
start:
    #!/usr/bin/env bash
    echo "‚ñ∂Ô∏è Starting Minecraft Marketplace..."
    docker start {{ container_name }}
    echo "‚úÖ Application started"

# Restart the application
restart: stop start

# Remove container (preserves data)
remove:
    #!/usr/bin/env bash
    echo "üóëÔ∏è Removing container..."
    docker stop {{ container_name }} 2>/dev/null || true
    docker rm {{ container_name }} 2>/dev/null || true
    echo "‚úÖ Container removed (data preserved)"

# STOP SERVICES: Shut down all services cleanly
down:
    #!/usr/bin/env bash
    echo "üõë Stopping Minecraft Marketplace services..."
    echo ""
    echo "   ‚úÖ OUTCOME: All services will be stopped"
    echo "   üíæ DATA: Database data is preserved"
    echo "   üîÑ TO RESTART: just infra (production) or just up (development)"
    echo ""
    
    docker compose down
    
    # Also stop dev compose if it exists
    if [ -f "compose.dev.yml" ]; then
        docker compose -f compose.dev.yml down 2>/dev/null || true
    fi
    
    echo "‚úÖ All services stopped successfully"

# VIEW LOGS: Show application logs with clear service identification
logs:
    #!/usr/bin/env bash
    echo "üìã Minecraft Marketplace Logs"
    echo "============================="
    echo ""
    echo "   ‚úÖ OUTCOME: Live log streaming from all services"
    echo "   üéØ PURPOSE: Monitor application behavior and debug issues"
    echo "   üí° TIP: Press Ctrl+C to stop log streaming"
    echo ""
    echo "üìä Service Legend:"
    echo "   ‚Ä¢ nginx: Reverse proxy and routing"
    echo "   ‚Ä¢ frontend: Astro + Svelte application"
    echo "   ‚Ä¢ backend: Hono API server"
    echo "   ‚Ä¢ db: PostgreSQL database"
    echo "   ‚Ä¢ postgrest: Auto-generated REST API"
    echo ""
    
    docker compose logs -f --tail=50

# === Maintenance Commands ===

# Clean up Docker resources
clean:
    #!/usr/bin/env bash
    echo "üßπ Cleaning up Docker resources..."
    
    # Remove stopped containers
    docker container prune -f
    
    # Remove unused images (keep latest)
    docker image prune -f
    
    # Remove unused volumes (careful with data!)
    echo "‚ö†Ô∏è Note: Not removing volumes to preserve data"
    
    echo "‚úÖ Cleanup complete"

# Full cleanup (DESTRUCTIVE - removes all data!)
clean-all:
    #!/usr/bin/env bash
    echo "‚ö†Ô∏è WARNING: This will remove ALL containers, images, and data!"
    read -p "Are you sure? (yes/no): " confirm
    
    if [ "$confirm" = "yes" ]; then
        echo "üßπ Performing full cleanup..."
        docker stop {{ container_name }} 2>/dev/null || true
        docker rm {{ container_name }} 2>/dev/null || true
        docker rmi {{ image_name }}:{{ image_tag }} 2>/dev/null || true
        rm -rf {{ data_volume }}
        rm -rf {{ backup_dir }}
        echo "‚úÖ Full cleanup complete"
    else
        echo "‚ùå Cleanup cancelled"
    fi

# Update application (rebuild and redeploy)
update: build up
    echo "üéâ Application updated successfully!"

# === Health and Monitoring ===

# HEALTH CHECK: Comprehensive service health validation
health:
    #!/usr/bin/env bash
    echo "üè• Minecraft Marketplace Health Check"
    echo "===================================="
    echo ""
    echo "   ‚úÖ OUTCOME: Comprehensive health validation"
    echo "   üéØ PURPOSE: Verify all services are working correctly"
    echo "   üìä SCOPE: Network, database, API, and frontend checks"
    echo ""
    
    # Check if services are running
    if ! docker compose ps --quiet | grep -q .; then
        echo "‚ùå DEPLOYMENT: No services running"
        echo "üöÄ FIX: Run 'just infra' to start services"
        exit 1
    fi
    
    echo "üîç RUNNING HEALTH CHECKS..."
    echo ""
    
    # Check main interface
    echo "1. Main Interface (http://localhost:7410)"
    if curl -f -s http://localhost:7410 >/dev/null 2>&1; then
        echo "   ‚úÖ Responding correctly"
    else
        echo "   ‚ùå Not responding"
        exit 1
    fi
    
    # Check service health status
    echo ""
    echo "2. Service Health Status"
    docker compose ps
    
    echo ""
    echo "üéâ ALL HEALTH CHECKS PASSED!"
    echo "üìç Access your marketplace at: http://localhost:7410"

# Show resource usage
stats:
    #!/usr/bin/env bash
    echo "üìä Resource Usage:"
    docker stats {{ container_name }} --no-stream --format "table {{{{.Name}}}}\t{{{{.CPUPerc}}}}\t{{{{.MemUsage}}}}\t{{{{.NetIO}}}}\t{{{{.BlockIO}}}}"

# === Utility Commands ===

# Connect to running container shell
shell:
    docker exec -it {{ container_name }} sh

# Run database migrations in container
migrate-container:
    docker exec {{ container_name }} npm run db:migrate

# Check container environment
env:
    docker exec {{ container_name }} env | sort

# === Collaboration Commands ===

# FRESH INSTALL TEST: Simulate new user deployment experience
fresh-install:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üÜï Fresh Install Experience Test"
    echo "==============================="
    echo ""
    echo "   ‚úÖ OUTCOME: Validates complete setup from scratch"
    echo "   üéØ PURPOSE: Ensure new users can deploy successfully"
    echo "   üìã STEPS: Clean ‚Üí Prerequisites ‚Üí Deploy ‚Üí Verify"
    echo "   ‚è±Ô∏è  EXPECTED TIME: ~60 seconds"
    echo ""
    
    start_time=$(date +%s)
    
    # Clean slate
    echo "üßπ STEP 1: Cleaning existing environment..."
    just down 2>/dev/null || true
    docker system prune -f >/dev/null 2>&1 || true
    echo "   ‚úÖ Environment cleaned"
    
    # Check prerequisites
    echo ""
    echo "üîç STEP 2: Prerequisites check..."
    if ! command -v docker &> /dev/null; then
        echo "   ‚ùå Docker not found - install Docker first"
        echo "   üìñ Guide: https://docs.docker.com/get-docker/"
        exit 1
    fi
    if ! docker compose version &> /dev/null; then
        echo "   ‚ùå Docker Compose not found"
        echo "   üìñ Guide: https://docs.docker.com/compose/install/"
        exit 1
    fi
    echo "   ‚úÖ Docker and Docker Compose available"
    
    # Deploy services
    echo ""
    echo "üöÄ STEP 3: Deploying services..."
    if just infra; then
        echo "   ‚úÖ Services deployed successfully"
    else
        echo "   ‚ùå Deployment failed"
        echo "   üîß Try: docker compose logs"
        exit 1
    fi
    
    # Verify functionality
    echo ""
    echo "üè• STEP 4: Verifying functionality..."
    if curl -f -s http://localhost:7410 > /dev/null 2>&1; then
        echo "   ‚úÖ Main interface accessible"
    else
        echo "   ‚ùå Main interface not accessible"
        exit 1
    fi
    
    end_time=$(date +%s)
    duration=$((end_time - start_time))
    
    echo ""
    echo "üéâ FRESH INSTALL SUCCESS!"
    echo "‚è±Ô∏è  Completed in ${duration} seconds"
    echo ""
    echo "üåê Your marketplace is ready at: http://localhost:7410"
    echo ""
    echo "üìã Next steps:"
    echo "   ‚Ä¢ just status  - Check service health"
    echo "   ‚Ä¢ just logs    - Monitor application logs"
    echo "   ‚Ä¢ just health  - Run comprehensive health check"

# DEMO PREPARATION: Ready environment for stakeholder presentation
demo:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üéØ Stakeholder Demo Preparation"
    echo "=============================="
    echo ""
    echo "   ‚úÖ OUTCOME: Demo-ready environment in ~30 seconds"
    echo "   üéØ PURPOSE: Prepare for stakeholder presentation"
    echo "   ‚è±Ô∏è  DEMO DURATION: 25-30 minutes total"
    echo "   üìç ACCESS: http://localhost:7410"
    echo ""
    
    start_time=$(date +%s)
    
    # Ensure clean, working environment
    echo "üöÄ Preparing demo environment..."
    just fresh-install >/dev/null 2>&1
    
    end_time=$(date +%s)
    duration=$((end_time - start_time))
    
    echo ""
    echo "üéâ DEMO ENVIRONMENT READY!"
    echo "‚è±Ô∏è  Preparation time: ${duration} seconds"
    echo ""
    echo "üìã DEMO SCRIPT (25-30 minutes):"
    echo ""
    echo "1. üöÄ Fresh Install Demo (3-5 minutes)"
    echo "   ‚Ä¢ Show 'just fresh-install' command"
    echo "   ‚Ä¢ Highlight 60-second deployment"
    echo "   ‚Ä¢ Demonstrate Docker Compose simplicity"
    echo ""
    echo "2. üåê Feature Tour (15-20 minutes)"
    echo "   ‚Ä¢ Main interface: http://localhost:7410"
    echo "   ‚Ä¢ User-centered design improvements"
    echo "   ‚Ä¢ Information architecture changes"
    echo "   ‚Ä¢ API documentation: http://localhost:7410/docs"
    echo ""
    echo "3. üè• Technical Health (2-3 minutes)"
    echo "   ‚Ä¢ Run 'just health' for service validation"
    echo "   ‚Ä¢ Show 'just status' for deployment overview"
    echo ""
    echo "4. üí¨ Q&A (5-10 minutes)"
    echo "   ‚Ä¢ Documentation in docs/ folder"
    echo "   ‚Ä¢ CLAUDE.md for development context"
    echo ""
    echo "üé§ READY TO PRESENT! Open http://localhost:7410 in your browser."

# === Internal Commands (prefixed with _) ===

# Create docker-compose.yml if it doesn't exist
_create-compose:
    #!/usr/bin/env bash
    cat > docker-compose.yml << 'EOF'
    version: '3.8'
    
    services:
      minecraft-marketplace:
        build: .
        ports:
          - "4321:4321"
        volumes:
          - ./data:/app/data
        environment:
          - NODE_ENV=production
          - HOST=0.0.0.0
          - PORT=4321
          - DB_PATH=/app/data/minecraft-marketplace.db
        restart: unless-stopped
        healthcheck:
          test: ["CMD", "node", "-e", "require('http').get('http://localhost:4321', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"]
          interval: 30s
          timeout: 3s
          retries: 3
    
      backup:
        image: alpine:latest
        volumes:
          - ./data:/data:ro
          - ./backups:/backups
        command: >
          sh -c "
            apk add --no-cache sqlite
            while true; do
              if [ -f /data/minecraft-marketplace.db ]; then
                timestamp=$$(date +%Y%m%d_%H%M%S)
                cp /data/minecraft-marketplace.db /backups/minecraft-marketplace-$${timestamp}.db
                echo \"Backup created: minecraft-marketplace-$${timestamp}.db\"
                # Keep only last 7 days of backups
                find /backups -name \"minecraft-marketplace-*.db\" -mtime +7 -delete
              fi
              sleep 3600
            done
          "
        restart: unless-stopped
    EOF
    
    echo "‚úÖ docker-compose.yml created"

# Show help for deployment
# HELP: Complete guide to using this justfile
help:
    #!/usr/bin/env bash
    cat << 'EOF'
    
    üéÆ Minecraft Marketplace - Command Guide
    =======================================
    
    üöÄ GETTING STARTED (Most Common Commands):
    -----------------------------------------
    just infra           # üéØ DEPLOY PRODUCTION ‚Üí http://localhost:7410
    just status          # üìä CHECK if services are running
    just health          # üè• VALIDATE all services working
    just logs            # üìã VIEW live application logs
    just down            # üõë STOP all services cleanly
    
    üîß DEVELOPMENT COMMANDS:
    -----------------------
    just up              # üîÑ DEVELOPMENT MODE with file watching
    just dev             # üî• START dev servers (requires infra first)
    just fresh-install   # üÜï TEST complete deployment from scratch
    just demo            # üéØ PREPARE for stakeholder demo
    
    üìä MONITORING & MAINTENANCE:
    ---------------------------
    just clean           # üßπ CLEANUP Docker resources
    just stats           # üìà SHOW resource usage
    just validate-collaboration  # ü§ù VALIDATE collaboration readiness
    
    üíæ DATABASE OPERATIONS:
    ----------------------
    just db-status       # üìã CHECK migration status
    just db-migrate      # ‚¨ÜÔ∏è  RUN database migrations
    just db-backup       # üíæ CREATE database backup
            
    üéØ QUICK REFERENCE:
    ------------------
    ‚Ä¢ Production deployment: just infra
    ‚Ä¢ Development mode: just up
    ‚Ä¢ Check if working: just health
    ‚Ä¢ View what's happening: just logs
    ‚Ä¢ Stop everything: just down
    
    üìç ACCESS POINTS (when running):
    ‚Ä¢ Main interface: http://localhost:7410
    ‚Ä¢ API documentation: http://localhost:7410/docs
    ‚Ä¢ Database API: http://localhost:7410/api/data
    
    üí° TIP: All commands show clear outcomes and next steps!
    
    EOF